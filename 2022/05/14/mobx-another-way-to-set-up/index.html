<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>再探 mobx，換個口味的寫法 - PeaNu&#39;s Paradise</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="這裡專門蒐集有用的前端開發知識，也是一個給自己做筆記的空間。如果你也熱衷於軟體開發，不訪來這裡逛逛吧！">



<meta name="keywords" content="前端,網頁開發,前端開發,網頁,軟體開發,JavaScript,HTML,CSS">



    <meta name="description" content="蠻有意思的。">
<meta property="og:type" content="article">
<meta property="og:title" content="再探 mobx，換個口味的寫法">
<meta property="og:url" content="https://jubeatt.github.io/2022/05/14/mobx-another-way-to-set-up/index.html">
<meta property="og:site_name" content="PeaNu&#39;s Paradise">
<meta property="og:description" content="蠻有意思的。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://jubeatt.github.io/2022/05/14/mobx-another-way-to-set-up/target.png">
<meta property="og:image" content="https://jubeatt.github.io/2022/05/14/mobx-another-way-to-set-up/re-render.gif">
<meta property="article:published_time" content="2022-05-14T11:42:06.000Z">
<meta property="article:modified_time" content="2023-09-08T02:42:53.473Z">
<meta property="article:author" content="PeaNu">
<meta property="article:tag" content="前端,網頁開發,前端開發,網頁,軟體開發,JavaScript,HTML,CSS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jubeatt.github.io/2022/05/14/mobx-another-way-to-set-up/target.png">





<link rel="icon" href="/img/base/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/agate.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    PeaNu
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">文章列表</a>
            
            <a class="navbar-item "
               href="/categories">分類</a>
            
            <a class="navbar-item "
               href="/recommend">推薦閱讀</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#簡述">1&nbsp;&nbsp;<b>簡述</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#範例">2&nbsp;&nbsp;<b>範例</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#關於-observer">3&nbsp;&nbsp;<b>關於 observer</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#關於-toJS（深拷貝）">4&nbsp;&nbsp;<b>關於 toJS（深拷貝）</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/jubeatt">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            再探 mobx，換個口味的寫法
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <span>5月 14 2022</span>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/React/">React</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>蠻有意思的。</p>
<span id="more"></span>

<h2 id="簡述"><a href="#簡述" class="headerlink" title="簡述"></a>簡述</h2><p>附註：後來發現其實這篇的精髓在於「mobx 提供的不同 API」讓你能用不同的方法來建立 store。總之推薦去看這份 <a target="_blank" rel="noopener" href="https://www.mobxjs.com/api">官方文件</a>，我覺得寫得還蠻清楚的。</p>
<p>在 <a href="https://jubeatt.github.io/2022/05/13/mobx-basic/">來點不一樣的狀態管理 mobx</a> 中已經介紹過基本的 mobx 觀念，忘記的話可以回去複習一下。</p>
<p>當時我們是透過 class 來建立一個 store，把所有 action、computed、state 都寫在一起，像這樣：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> { action, computed, makeObservable, observable } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">interface</span> TodoItem {</span><br><span class="line">  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span></span><br><span class="line">  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span><br><span class="line">  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TodoStoreImpl</span> </span>{</span><br><span class="line">  <span class="hljs-attr">todos</span>: TodoItem[] = []</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {</span><br><span class="line">    makeObservable(<span class="hljs-built_in">this</span>, {</span><br><span class="line">      <span class="hljs-attr">todos</span>: observable,</span><br><span class="line">      <span class="hljs-attr">addTodo</span>: action,</span><br><span class="line">      <span class="hljs-attr">toggleTodo</span>: action,</span><br><span class="line">      <span class="hljs-attr">states</span>: computed</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  addTodo(name: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</span><br><span class="line">    <span class="hljs-keyword">const</span> item: TodoItem = {</span><br><span class="line">      <span class="hljs-attr">id</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),</span><br><span class="line">      name,</span><br><span class="line">      <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span></span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-built_in">this</span>.todos.push(item)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  toggleTodo(id: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</span><br><span class="line">    <span class="hljs-keyword">const</span> index = <span class="hljs-built_in">this</span>.todos.findIndex(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.id === id)</span><br><span class="line">    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {</span><br><span class="line">      <span class="hljs-built_in">this</span>.todos[index].completed = !<span class="hljs-built_in">this</span>.todos[index].completed</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">get</span> <span class="hljs-title">states</span>() {</span><br><span class="line">    <span class="hljs-keyword">let</span> completed: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">let</span> remaining: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-built_in">this</span>.todos.forEach(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {</span><br><span class="line">      <span class="hljs-keyword">if</span> (item.completed) {</span><br><span class="line">        completed++</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        remaining++</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-keyword">return</span> { completed, remaining }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TodoStore = <span class="hljs-keyword">new</span> TodoStoreImpl()</span><br></pre></td></tr></tbody></table></figure>

<p>簡單來說，我們會先寫好一個 store 的藍圖，接著再把 instance 輸出到外面。</p>
<p>雖然這樣也不錯，不過其實也有不需要透過 class 的寫法，下面就來介紹一下。</p>
<h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>這邊一樣會拿 Todo list 來當範例，不過在那之前要先介紹一下資料夾結構。</p>
<p>我們現在不會寫成一個 <code>todoStore.ts</code>，而是要拆成這樣的結構：</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">└── state</span><br><span class="line">    ├── action</span><br><span class="line">    │&nbsp;&nbsp; └── todo.tsx</span><br><span class="line">    └── storage</span><br><span class="line">        └── todo.tsx</span><br></pre></td></tr></tbody></table></figure>

<p>簡單來說就是把 action 和 state 給拆開來寫，<code>action/todo.ts</code> 裡面只會放跟 action 有關的東西，而 <code>storage/todo.ts</code> 則會放跟 state 有關的東西。</p>
<p>接著先來看 state 的部分：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> { observable } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Todo = {</span><br><span class="line">  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span></span><br><span class="line">  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span><br><span class="line">  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> State = {</span><br><span class="line">  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">number</span></span><br><span class="line">  <span class="hljs-attr">remaining</span>: <span class="hljs-built_in">number</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TodoStorage = observable({</span><br><span class="line">  <span class="hljs-comment">// state</span></span><br><span class="line">  <span class="hljs-attr">todos</span>: [] <span class="hljs-keyword">as</span> Todo[],</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// computed</span></span><br><span class="line">  <span class="hljs-keyword">get</span> <span class="hljs-title">state</span>(): <span class="hljs-title">State</span> {</span><br><span class="line">    <span class="hljs-keyword">let</span> completed = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">let</span> remaining = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-built_in">this</span>.todos.forEach(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {</span><br><span class="line">      <span class="hljs-keyword">if</span> (item.completed) {</span><br><span class="line">        completed++</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        remaining++</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-keyword">return</span> { completed, remaining }</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>我們會有一個 todos 的 state，跟一個已完成 / 未完成的 computed。</p>
<p>其實就跟 class 的寫法很像，只是現在把東西全部包成一個 object 在丟到 <code>observable</code> 裡面而已。</p>
<p>接著來看 action：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> { action } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { TodoStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/todo'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addTodo = action((name: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</span><br><span class="line">  TodoStorage.todos.push({</span><br><span class="line">    <span class="hljs-attr">id</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),</span><br><span class="line">    name,</span><br><span class="line">    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span></span><br><span class="line">  })</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> toggleTodo = action((id: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">const</span> index = TodoStorage.todos.findIndex(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.id === id)</span><br><span class="line">  <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {</span><br><span class="line">    TodoStorage.todos[index].completed = !TodoStorage.todos[index].completed</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>我們會有新增 todo 跟更新 todo 的兩個 action。</p>
<p>跟剛剛的做法差不多，我們把用來執行的 function 放到 <code>action</code> 裡面去，這樣就建立完成了。</p>
<p>最後就是跟 Component 串起來而已，我來貼一段：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { TodoStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/storage/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { toggleTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/action/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { observer } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx-react-lite'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 別忘了一樣要用 observer 來包住</span></span><br><span class="line"><span class="hljs-keyword">const</span> TodoList: React.FC = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      Completed: {TodoStorage.state.completed} <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      Remaining: {TodoStorage.state.remaining}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {TodoStorage.todos.map((item) =&gt; {</span></span><br><span class="line"><span class="hljs-xml">          return (</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(item.id)} key={item.id}&gt;</span></span><br><span class="line"><span class="hljs-xml">              [{item.completed ? 'X' : ' '}] {item.name}</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          )</span></span><br><span class="line"><span class="hljs-xml">        })}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> TodoList</span><br></pre></td></tr></tbody></table></figure>

<p>以上就是第二種寫法的示範。</p>
<p>我覺得這種寫法在有些時候會更直覺一些，因為透過這種方式在 Component 裡面就不需要把整個 store 引進來，可以只把需要的 action 或 state 拿來用就好，所以會更簡潔一點。</p>
<p>最後老樣子，需要範例的話來 <a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-de-ling-wai-yi-zhong-xie-fa-4tbvxt?file=/src/App.tsx">這邊</a> 看。</p>
<h2 id="關於-observer"><a href="#關於-observer" class="headerlink" title="關於 observer"></a>關於 observer</h2><p>實在不知道這段怎麼下標題，總之這邊想來談談「關於重新渲染的問題」，這跟 mobx 中的 observer 有一些關聯。</p>
<p>我先講結論，就是：</p>
<ul>
<li>observer 無法直接觸發<strong>子元件</strong> re-render</li>
<li>observer 無法直接觸發<strong>子元件</strong> re-render</li>
<li>observer 無法直接觸發<strong>子元件</strong> re-render</li>
</ul>
<p>好，我知道這樣講一定聽不懂，所以又到了我們的範例時間。假設我有一段 code 的基本結構長這樣：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">return</span> (</span><br><span class="line">  <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'app'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">''</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">'login'</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Login</span> /&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>就是一個很基本的導覽列和路由，長得像這樣：</p>
<p><img src="target.png" alt="target"></p>
<p>我這邊想做的事情很簡單，就是在 store 中建立一個 <code>isInit</code> 的 state，然後我希望上面紅色框框的兩個按鈕只有在 <code>isInit=true</code> 時才顯示出來。</p>
<p>所以這邊的 store 跟 action 就會這樣寫：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// store</span></span><br><span class="line"><span class="hljs-keyword">import</span> { observable } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> AuthStorage = observable({</span><br><span class="line">  <span class="hljs-attr">isInit</span>: <span class="hljs-literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">get</span> <span class="hljs-title">getIsinit</span>() {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isInit</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// action</span></span><br><span class="line"><span class="hljs-keyword">import</span> { action } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { AuthStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/auth'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> checkStorage = action(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  AuthStorage.isInit = <span class="hljs-literal">true</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>附註：如果你串過 JWT 的話大概就會知道這是起手式，只是這邊為了簡化所以不會真的去檢查 storage。</p>
<p>接下來，為了在進入頁面時完成「初始化」的動作，我們會用 <code>useEffect</code> 來處理，像這樣：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 注意這邊有用 observer 來觀測</span></span><br><span class="line"><span class="hljs-keyword">const</span> App = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'render app'</span>)</span><br><span class="line">  useEffect(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">    <span class="hljs-comment">// set isInit to true</span></span><br><span class="line">    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">      checkStorage()</span><br><span class="line">    }, <span class="hljs-number">1000</span>)</span><br><span class="line">  }, [])</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'app'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">''</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">'login'</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Login</span> /&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App</span><br></pre></td></tr></tbody></table></figure>

<p>接下來你可能就很開心的去 <code>&lt;Header /&gt;</code> 中把 <code>isInit</code> 拿出來用，像這樣：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> Header = <span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          Home</span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.list}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            default</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {/* 加上條件渲染 */}</span></span><br><span class="line"><span class="hljs-xml">        {AuthStorage.getIsinit &amp;&amp; (</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">                Link1</span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">                Link2</span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        )}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Header</span><br></pre></td></tr></tbody></table></figure>

<p>附註：可以到這邊看 <a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-observer-problem-vjduxw?file=/src/App.js">範例</a> 會更清楚</p>
<p>然後你就會發現一秒過後什麼事情也沒發生，跟你想的不一樣。</p>
<blockquote>
<p>為什麼？我明明已經用 observer 來觀測整個 App 了啊，照理來說只要有任何 state 改變了不就應該重新渲染嗎？</p>
</blockquote>
<p>要解開這個問題，首先要釐清一件事情：「observer 的觀察範圍在哪裡？」</p>
<p>以上面的例子來說，observer 的觀察範圍就僅限於 <code>App</code> 這個元件<strong>本身</strong>而已。既然如此，那麼思考一件事情，<code>App</code> 中有沒有用到任何「observable（被觀察）」的值？</p>
<p>答案是沒有，忘記的話你可以拉上去看一下。</p>
<p>也就是說，只有當 observer 中存在 observable 時，才會再更新時觸發 re-render。（這一句請搞清楚 observer 跟 observable 的差的差別，一個是觀察者，一個是被觀察者）</p>
<p>所以如果要讓 <code>App</code> 觸發 re-render，最簡單的做法就是讓 App 裡面出現 observable，像這樣：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> App = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'render app'</span>)</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'check observable'</span>, AuthStorage.getIsinit)</span><br><span class="line">  useEffect(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">    <span class="hljs-comment">// set isInit be true</span></span><br><span class="line">    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">      checkStorage()</span><br><span class="line">    }, <span class="hljs-number">1000</span>)</span><br><span class="line">  }, [])</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'app'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">''</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">'login'</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Login</span> /&gt;</span>} /&gt;</span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App</span><br></pre></td></tr></tbody></table></figure>

<p>這時候神奇的事情就發生了，真的觸發 re-render 了：</p>
<p><img src="re-render.gif" alt="re-render"></p>
<p>附註：範例可以參考<a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-observer-add-observable-1up66o?file=/src/App.js">這邊</a></p>
<p>就跟我們剛剛說的一樣，現在因為 App 中出現了 observable，所以一旦這個 observable 「被改變了」，App 就應該要 re-render，這就是背後的道理而已，別想得太複雜了。</p>
<p>所以回到一開始的問題，如果我想讓 <code>&lt;Header /&gt;</code> 能正確的被重新渲染的話該怎麼做？</p>
<p>只要幫他加上 <code>observer</code> 就好（因為 observable 是出現在它裡面的，這個才是我們真正該觀察（observer）的元件）：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 加上 observer</span></span><br><span class="line"><span class="hljs-keyword">const</span> Header = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          Home</span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.list}</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            default</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {AuthStorage.getIsinit &amp;&amp; (</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">                Link1</span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.link}</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'login'</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">                Link2</span></span><br><span class="line"><span class="hljs-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        )}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Header</span><br></pre></td></tr></tbody></table></figure>

<p>附註：範例參考<a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-observer-solution-21b26x?file=/src/Header.js">這裡</a></p>
<p>總之，一定要搞清楚 observer 的涵蓋範圍在哪裡？它跟 observable 的關係又是什麼？是一段想講的重要觀念。</p>
<h2 id="關於-toJS（深拷貝）"><a href="#關於-toJS（深拷貝）" class="headerlink" title="關於 toJS（深拷貝）"></a>關於 toJS（深拷貝）</h2><p>這邊是我後來在做專案時碰到的一個問題，所以記錄一下。</p>
<p>簡單來說上面的範例其實可以再利用 <code>computed</code> 的方式來取出 state，像這樣：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TodoStorage = observable({</span><br><span class="line">  <span class="hljs-comment">// 存在 store 中的 state</span></span><br><span class="line">  <span class="hljs-attr">todos</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,</span><br><span class="line">      <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>,</span><br><span class="line">      <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span></span><br><span class="line">    }</span><br><span class="line">  ] <span class="hljs-keyword">as</span> Todo[],</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 把 state 直接當作 computed 傳出去</span></span><br><span class="line">  <span class="hljs-keyword">get</span> <span class="hljs-title">getTodos</span>(): <span class="hljs-title">Todo</span>[] {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.todos</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>用的時候會像這樣：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> TodoList: React.FC = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {TodoStorage.getTodos.map((item) =&gt; (</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(item.id)} key={item.id}&gt;</span></span><br><span class="line"><span class="hljs-xml">            {item.name}</span></span><br><span class="line"><span class="hljs-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        ))}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p>你可能會想說明明能用 <code>TodoStorage.todos</code> 拿出來就好了，為什麼要這樣寫？</p>
<p>這是因為單用 <code>TodoStorage.todos</code> 拿出來的話：</p>
<ul>
<li><strong>他是有被修改的風險在的</strong></li>
<li><strong>他是有被修改的風險在的</strong></li>
<li><strong>他是有被修改的風險在的</strong></li>
</ul>
<p>因為我們拿出來的東西其實是「reference」，所以我只要在拿出來的時候亂改，就會改到「原本放在 store」 裡面的東西，像這樣：</p>
<figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { TodoStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/storage/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { toggleTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/action/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { observer } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx-react-lite'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> TodoList: React.FC = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-comment">// 拿出來後亂改</span></span><br><span class="line">  TodoStorage.todos[<span class="hljs-number">0</span>].name = <span class="hljs-string">'yoyoyo'</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {TodoStorage.todos.map((item) =&gt; {</span></span><br><span class="line"><span class="hljs-xml">          return (</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(item.id)} key={item.id}&gt;</span></span><br><span class="line"><span class="hljs-xml">              {/* 原本是 test，但會被改成 yoyoyo  */}</span></span><br><span class="line"><span class="hljs-xml">              {item.name}</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          )</span></span><br><span class="line"><span class="hljs-xml">        })}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> TodoList</span><br></pre></td></tr></tbody></table></figure>

<p>附註：不懂的話可以到這邊看<a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-xiu-gai-store-de-zhi-sz7k6k?file=/src/components/TodoList.tsx">範例</a></p>
<p>所以比較保險的方式是先把 state 做深拷貝以後再拿出來，這樣子就算之後意外的改到 state，那也不會影響到 store 裡面的東西（這個就是深拷貝的原理，不懂的話回去複習）。</p>
<p>這時候就會用到 <code>toJS</code> 這個方法了，來把一開始講的方法改成這樣：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> TodoStorage = observable({</span><br><span class="line">  <span class="hljs-attr">todos</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,</span><br><span class="line">      <span class="hljs-attr">name</span>: <span class="hljs-string">"Test"</span>,</span><br><span class="line">      <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span></span><br><span class="line">    }</span><br><span class="line">  ] <span class="hljs-keyword">as</span> Todo[],</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">get</span> <span class="hljs-title">getTodosWithToJS</span>(): <span class="hljs-title">Todo</span>[] {</span><br><span class="line">    <span class="hljs-comment">// 做深拷貝後在回傳</span></span><br><span class="line">    <span class="hljs-keyword">return</span> toJS(<span class="hljs-built_in">this</span>.todos);</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { TodoStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/storage/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { toggleTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">'../state/action/todo'</span></span><br><span class="line"><span class="hljs-keyword">import</span> { observer } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx-react-lite'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> TodoList: React.FC = observer(<span class="hljs-function">() =&gt;</span> {</span><br><span class="line">  <span class="hljs-comment">// 一樣亂改值，但只會改到拷貝後的物件</span></span><br><span class="line">  TodoStorage.getTodosWithToJS[<span class="hljs-number">0</span>].name = <span class="hljs-string">'yoyoyo'</span></span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-xml"><span class="hljs-tag">&lt;&gt;</span></span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">        {TodoStorage.todos.map((item) =&gt; {</span></span><br><span class="line"><span class="hljs-xml">          return (</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(item.id)} key={item.id}&gt;</span></span><br><span class="line"><span class="hljs-xml">              {/* 不會影響到原本的 todos  */}</span></span><br><span class="line"><span class="hljs-xml">              {item.name}</span></span><br><span class="line"><span class="hljs-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">          )</span></span><br><span class="line"><span class="hljs-xml">        })}</span></span><br><span class="line"><span class="hljs-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span></span><br><span class="line"><span class="hljs-xml">    <span class="hljs-tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> TodoList</span><br></pre></td></tr></tbody></table></figure>

<p>不懂的話一樣來這邊看<a target="_blank" rel="noopener" href="https://codesandbox.io/s/mobx-tojs-de-yong-fa-095xvb?file=/src/components/TodoList.tsx">範例</a>。</p>
<p>總之呢，<code>toJS</code> 通常是用在你「想要拿 state 來做一些計算時」會拿來用的東西，為的就是避免在途中不小心改到 store 裡的東西，所以才會用這種方式來盡可能避免掉。</p>
<p>如果你的 state 只是純粹拿來 Read 的話，那不用這種方式也沒關係，但要知道要有這種作法就是了。</p>
<blockquote>
<p>最後的附註：雖然準確一點來說 <code>toJS</code> 的用途是「取消 observable」，不過我覺得用「深拷貝」的方式來理解會更好懂一點（當初完全聽不懂什麼叫取消 observable XD）</p>
</blockquote>
</body></html>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2022/05/15/antd-table/">Ant Design－Table</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/05/14/react-router-dom-hook/">React router dom 相關的 hook</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 PeaNu&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/jubeatt">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-TW");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>